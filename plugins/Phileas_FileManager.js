//=============================================================================
// Phileas_FileManager.js
//=============================================================================
// [Update History]
// 2025.February.16 Ver1.0.0 First Release
// 2025.February.17 Ver1.0.1 Added read/write file methods

/*:
 * @target MZ
 * @plugindesc 1.0.0 Cross-platform file manager
 * @author Phileas
 * 
 * @param updateStamp
 * @text Update files stamp at startup
 * @type boolean
 * @desc Disable this before deploying the game
 * @default true
 * 
 * 
 * @help
 * 
 * This is an auxiliary plugin that allows to work with files in any environment.
 * 
 * The plugin provides the following methods that can be used in other
 * plugins or scripts:
 * - Phileas_FileManager.fileExistsSync(path) - synchronously checks for file availability
 * - Phileas_FileManager.getFilesInDirectory(path) - synchronously returns a list of files
 *   in the specified directory, including nested directories of any level
 * - Phileas_FileManager.readFile(path) - asynchronously returns the contents of the file
 * - Phileas_FileManager.readJsonFile(path) - asynchronously returns the deserialized contents
 *   of the JSON file
 * - Phileas_FileManager.writeFile(path, data) - asynchronously saves the specified
 *   data to a file
 * - Phileas_FileManager.writeJsonFile(path, data) - serializes the specified data in JSON
 *   and asynchronously saves it to a file
 * - Phileas_FileManager.downloadFile(path) - downloads a file from the local storage.
 *   This method only works in a web environment and on mobile platforms.
 *   The method must be called after saving the file using Phileas_FileManager.writeFile
 *   or Phileas_FileManager.writeJsonFile
 * - Phileas_FileManager.importSaveFile - imports the save file to and on Android
 * 
 * The path in all methods is the path to the file/directory relative to the root of the game.
 * 
 * Contact the author of the plugin if you need other methods or commands of the plugin.
 *
 * In order for the plugin to work in the browser and on mobile devices, it is necessary
 * the current data/FilesStamp.json file.
 * This file contains information about all the game files.
 * This file is automatically generated when the game starts, if enabled
 * the updateStamp parameter. This plugin parameter is recommended
 * disable it before deployment.
 * 
 * 
 * You can always write to the author if you need other features or even plugins.
 * Boosty: https://boosty.to/phileas
 * RPG Maker Web: https://forums.rpgmakerweb.com/index.php?members/phileas.176075/
 * RPG Maker Union: https://rpgmakerunion.ru/id/phileas
 * Email: olek.olegovich gmail.com
 * Telegram: olekolegovich
 * 
 *-----------------------------------------------------------------------------
 * [License]
 * This plugin is released under MIT license.
 * http://opensource.org/licenses/mit-license.php
 *
 * This means that you can freely use the plugin in non-commercial and commercial games and even edit it.
 * But be sure to include me in the credits!
 */

/*:ru
 * @target MZ
 * @plugindesc 1.0.0 ÐšÑ€Ð¾ÑÑÐ¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð¾Ð²
 * @author Phileas
 * 
 * @param updateStamp
 * @text ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑˆÑ‚Ð°Ð¼Ð¿ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ
 * @type boolean
 * @desc ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼ Ð¸Ð³Ñ€Ñ‹
 * @default true
 * 
 * 
 * @help
 * 
 * Ð­Ñ‚Ð¾ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ð² Ð»ÑŽÐ±Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ.
 * 
 * ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ…
 * Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°Ñ… Ð¸Ð»Ð¸ Ð² ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ñ…:
 * - Phileas_FileManager.fileExistsSync(path) - ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð°
 * - Phileas_FileManager.getFilesInDirectory(path) - ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð²
 *   Ð² ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð»ÑŽÐ±Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ
 * - Phileas_FileManager.readFile(path) - Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð°
 * - Phileas_FileManager.readJsonFile(path) - Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð´ÐµÑÐµÑ€Ð¸Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ
 *   ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ JSON-Ñ„Ð°Ð¹Ð»Ð°
 * - Phileas_FileManager.writeFile(path, data) - Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ðµ
 *   Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»
 * - Phileas_FileManager.writeJsonFile(path, data) - ÑÐµÑ€Ð¸Ð°Ð»Ð¸Ð·ÑƒÐµÑ‚ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
 *   Ð² JSON Ð¸ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð¸Ñ… Ñ„Ð°Ð¹Ð»
 * - Phileas_FileManager.downloadFile(path) - ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ñ„Ð°Ð¹Ð» Ð¸Ð· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°.
 *   Ð­Ñ‚Ð¾Ñ‚ Ð¼ÐµÑ‚Ð¾Ð´ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð²ÐµÐ±-ÑÑ€ÐµÐ´Ðµ Ð¸ Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ…. ÐœÐµÑ‚Ð¾Ð´ Ð½ÑƒÐ¶Ð½Ð¾
 *   Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Phileas_FileManager.writeFile
 *   Ð¸Ð»Ð¸ Phileas_FileManager.writeJsonFile
 * - Phileas_FileManager.importSaveFile - Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ð¸ Ð½Ð° Android
 * 
 * path Ð²Ð¾ Ð²ÑÐµÑ… Ð¼ÐµÑ‚Ð¾Ð´Ð°Ñ… - ÑÑ‚Ð¾ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ/Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÐºÐ¾Ñ€Ð½Ñ Ð¸Ð³Ñ€Ñ‹
 * 
 * ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°, ÐµÑÐ»Ð¸ Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ Ð¸Ð»Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.
 * 
 * Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ Ð¸ Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ…, Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼
 * Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» data/FilesStamp.json.
 * Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð±Ð¾ Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð°Ñ… Ð¸Ð³Ñ€Ñ‹.
 * Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð¸Ð³Ñ€Ñ‹, ÐµÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½
 * Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ updateStamp. Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ
 * Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐµÐ¼.
 * 
 * 
 * Ð’Ñ‹ Ð²ÑÐµÐ³Ð´Ð° Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ, ÐµÑÐ»Ð¸ Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¸Ð»Ð¸ Ð´Ð°Ð¶Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹.
 * Boosty: https://boosty.to/phileas
 * RPG Maker Web: https://forums.rpgmakerweb.com/index.php?members/phileas.176075/
 * RPG Maker Union: https://rpgmakerunion.ru/id/phileas
 * Email: olek.olegovich gmail.com
 * Telegram: olekolegovich
 * 
 *-----------------------------------------------------------------------------
 * [License]
 * Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð¿Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ MIT.
 * http://opensource.org/licenses/mit-license.php
 *
 * Ð­Ñ‚Ð¾ Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð² Ð½ÐµÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ¸Ñ…
 * Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ¸Ñ… Ð¸Ð³Ñ€Ð°Ñ… Ð¸ Ð´Ð°Ð¶Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾.
 * ÐÐ¾ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¼ÐµÐ½Ñ Ð² Ñ‚Ð¸Ñ‚Ñ€Ð°Ñ…!
 * 
 */

"use strict";


function Phileas_FileManager() {
    throw new Error("This is a static class");
}
 
Phileas_FileManager._stampFile = "data/FilesStamp.json";
Phileas_FileManager._cache = {};
 
Phileas_FileManager._parameters = PluginManager.parameters("Phileas_FileManager");
Phileas_FileManager._updateRequired = Phileas_FileManager._parameters["updateStamp"] == "true";
 
Phileas_FileManager.scanFileSystem = async function() {
    if (!Utils.isNwjs() || !Phileas_FileManager._updateRequired) {
        return;
    }
 
    const fs = require("fs");
    const path = require("path");
    const projectPath = path.dirname(process.mainModule.filename);
    const stampFile = path.join(projectPath, Phileas_FileManager._stampFile);
 
    function scanDir(dir) {
        let result = {};
        fs.readdirSync(dir).forEach(file => {
            const fullPath = path.join(dir, file);
            if (fs.statSync(fullPath).isDirectory()) {
                result[file] = scanDir(fullPath);
            } else {
                result[file] = true;
            }
        });
 
        return result;
    }
 
    const fileTree = scanDir(projectPath);
    fs.writeFileSync(stampFile, JSON.stringify(fileTree, null, 2));
    console.log("Phileas_FileManager: file scanning completed");
};
 
Phileas_FileManager.loadCache = async function() {
    if (Utils.isNwjs()) {
        return;
    }
 
    try {
        const response = await fetch(Phileas_FileManager._stampFile);

        if (!response.ok) {
            throw new Error(`${Phileas_FileManager._stampFile} not found`);
        }
 
        Object.assign(Phileas_FileManager._cache, await response.json());
        console.log("Phileas_FileManager: cache loaded");
    } catch (error) {
        console.error("Phileas_FileManager: cache loading failed", error);
    }
};
 
Phileas_FileManager.fileExistsSync = function(path) {
    if (Utils.isNwjs()) {
        const fs = require("fs");
        return fs.existsSync(path);
    }
 
    const parts = path.split("/");
    let current = Phileas_FileManager._cache;
    for (const part of parts) {
        if (!current[part]) {
            return false;
        }
 
        current = current[part];
    }
 
    return true;
};
 
Phileas_FileManager.getFilesInDirectoryNwJs = function(path) {
    const fs = require("fs");
    const pathModule = require("path");
    const projectPath = pathModule.dirname(process.mainModule.filename);
    const fullPath = pathModule.join(projectPath, path);
 
    function scanDir(dir) {
        let files = [];
        fs.readdirSync(dir).forEach(file => {
            const filePath = pathModule.join(dir, file);
            if (fs.statSync(filePath).isDirectory()) {
                files = files.concat(scanDir(filePath).map(subFile => file + "/" + subFile));
            } else {
                files.push(file);
            }
        });
        return files;
    }
 
    if (!fs.existsSync(fullPath) || !fs.statSync(fullPath).isDirectory()) {
        console.warn("Path not found:", path);
        return [];
    }
 
    return scanDir(fullPath);
}
 
Phileas_FileManager.getFilesInDirectoryWeb = function(path) {
    const parts = path.split("/").filter(Boolean);
    let current = Phileas_FileManager._cache;
    for (const part of parts) {
        if (!current[part]) {
            return [];
        }

        current = current[part];
    }
 
    function collectFiles(node, prefix = "") {
        let files = [];
        for (const key in node) {
            if (typeof node[key] === "object") {
                files = files.concat(collectFiles(node[key], prefix + key + "/"));
            } else {
                files.push(prefix + key);
            }
        }

        return files;
    }
 
    return collectFiles(current);
}
 
Phileas_FileManager.getFilesInDirectory = function(path) {
    return Utils.isNwjs()
        ? Phileas_FileManager.getFilesInDirectoryNwJs(path)
        : Phileas_FileManager.getFilesInDirectoryWeb(path);
};

Phileas_FileManager.readFileNwJs = async function(path) {
    const fs = require("fs");
    const pathModule = require("path");
    const fullPath = pathModule.join(pathModule.dirname(process.mainModule.filename), path);
    return fs.readFileSync(fullPath, "utf8");
};

Phileas_FileManager.readFileWeb = async function(path) {
    const data = localStorage.getItem(path);
    return data;
};

Phileas_FileManager.readFile = async function(path) {
    if (Utils.isNwjs()) {
        return Phileas_FileManager.readFileNwJs(path);
    }

    return Phileas_FileManager.readFileWeb(path);
};

Phileas_FileManager.readJsonFile = async function(path) {
    const data = Phileas_FileManager.readFile(path);
    return data ? JSON.parse(data) : null;
};

Phileas_FileManager.writeFileNwJs = async function(path, data) {
    const fs = require("fs");
    const pathModule = require("path");
    const fullPath = pathModule.join(pathModule.dirname(process.mainModule.filename), path);
    fs.writeFileSync(fullPath, data);
    console.log(`Saved file: ${path}`);
};

Phileas_FileManager.writeFileWeb = async function(path, data) {
    localStorage.setItem(path, data);
    console.log(`Saved file to localStorage: ${path}`);
};

Phileas_FileManager.writeFile = async function(path, data) {
    if (Utils.isNwjs()) {
        Phileas_FileManager.writeFileNwJs(path, data);
        return;
    }

    Phileas_FileManager.writeFileWeb(path, data);
};

Phileas_FileManager.writeJsonFile = async function(path, data) {
    Phileas_FileManager.writeFile(path, JSON.stringify(data));
};

Phileas_FileManager.downloadFile = function(path) {
    if (Utils.isNwjs()) {
        console.warn("Phileas_FileManager.downloadFile method is only for the web environment");
        return;
    }

    const data = localStorage.getItem(path);
    if (!data) {
        console.warn(`File not found in localStorage: ${path}`);
        return;
    }

    const blob = new Blob([data], { type: "application/json" });
    const fileName = path.split("/").pop();

    if (navigator.userAgent.toLowerCase().includes("android")) {
        const fileReader = new FileReader();
        fileReader.onload = function () {
            const base64Data = fileReader.result.split(",")[1];
            if (window.Android && window.Android.saveBase64File) {
                window.Android.saveBase64File(fileName, base64Data);
                console.log(`File saved on Android: /storage/emulated/0/Download/${fileName}`);
            } else {
                console.warn("Android API not found");
                return;
            }
        };

        fileReader.readAsDataURL(blob);
        return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = fileName;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
    console.log(`ðŸ“‚ File downloaded: ${a.download}`);
    console.log(`ðŸ“‚ Expected save location: Downloads/${a.download}`);
};

Phileas_FileManager.importSaveFileWeb = function() {
    if (Utils.isNwjs()) {
        console.warn("Phileas_FileManager.importSaveFile is only for the web environment");
        return;
    }

    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".rpgsave";

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function() {
            const fileName = file.name;
            localStorage.setItem(fileName, reader.result);
            console.log(`ðŸ“‚ Save file imported: ${fileName} (stored in localStorage)`);
        };
        reader.readAsDataURL(file);
    };

    input.click();
};

Phileas_FileManager.importSaveFileAndroid = function() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".rpgsave";

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function() {
            const base64Data = reader.result.split(",")[1];
            const fileName = file.name;

            if (window.Android && window.Android.saveBase64File) {
                window.Android.saveBase64File("save/" + fileName, base64Data);
                console.log(`ðŸ“‚ Save file imported: /data/data/com.yourgame.app/files/save/${fileName}`);
            } else {
                console.warn("Android API not found");
            }
        };
        reader.readAsDataURL(file);
    };

    input.click();
};

Phileas_FileManager.importSaveFile = function() {
    if (Utils.isNwjs()) {
        console.warn("Phileas_FileManager.importSaveFile is only for the web environment");
        return;
    }

    if (!navigator.userAgent.toLowerCase().includes("android")) {
        Phileas_FileManager.importSaveFileAndroid();
        return;
    }

    Phileas_FileManager.importSaveFileWeb();
};

 
Phileas_FileManager.scanFileSystem();
Phileas_FileManager.loadCache();
 